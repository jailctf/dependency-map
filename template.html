<html>
    <head>
        <style>
            /* http://meyerweb.com/eric/tools/css/reset/ 
               v2.0 | 20110126
               License: none (public domain)
            */
            
            html, body, div, span, applet, object, iframe,
            h1, h2, h3, h4, h5, h6, p, blockquote, pre,
            a, abbr, acronym, address, big, cite, code,
            del, dfn, em, img, ins, kbd, q, s, samp,
            small, strike, strong, sub, sup, tt, var,
            b, u, i, center,
            dl, dt, dd, ol, ul, li,
            fieldset, form, label, legend,
            table, caption, tbody, tfoot, thead, tr, th, td,
            article, aside, canvas, details, embed, 
            figure, figcaption, footer, header, hgroup, 
            menu, nav, output, ruby, section, summary,
            time, mark, audio, video {
            	margin: 0;
            	padding: 0;
            	border: 0;
            	font-size: 100%;
            	font: inherit;
            	vertical-align: baseline;
            }
            /* HTML5 display-role reset for older browsers */
            article, aside, details, figcaption, figure, 
            footer, header, hgroup, menu, nav, section {
            	display: block;
            }
            body {
            	line-height: 1;
            }
            ol, ul {
            	list-style: none;
            }
            blockquote, q {
            	quotes: none;
            }
            blockquote:before, blockquote:after,
            q:before, q:after {
            	content: '';
            	content: none;
            }
            table {
            	border-collapse: collapse;
            	border-spacing: 0;
            }
            a {
                color: #72D9DE;
            }
        </style>
        <style>
            body,html {
                width: 100%;
                height: 100%;
                padding: 0px;
                margin: 0px;
                overflow: hidden;
            }
            body {
                display: flex;
                flex-direction: row;
            }
            #graph {
                width: 80%;
                height: 100%;
                background-color: #313338;
            }
            #notes {
                width: calc(20% - 13px);
                height: 100%;
                background-color: #2b2d31;
                padding-left: 13px;
                overflow-y: auto;
            }
            h1, p {
                color: white;
                font-family: Helvetica;
            }
            h1 {
                margin: 13px;
                margin-left: 0px;
                padding-top: 4px;
                padding-bottom: 4px;
                padding-left: 7px;
                border-left: 3px solid white;
                font-weight: bold;
            }
            .code-reference-element {
                margin-right: 13px;
            }
            .code-reference-element:hover {
                background-color: #ffffff33;
            }
            .code-reference-element .line {
                font-family: "Courier New";
            }
            .code-reference-element .where {
                font-style: italic;
                margin-top: 10px;
                border-bottom: 1px solid #aaa;
            }
            #search {
                max-height: 100%;
                overflow-y: auto;
                position: absolute;
                max-width: 20%;
                padding-right: 16px;
                padding-bottom: 12px;
                z-index: 10000;
                background-color: #2b2d31;
                padding-left: 13px;
                display: flex;
                flex-direction: column;
            }
            #search-input {
                border-radius: 0px;
                border: 1px solid black;
                outline: none;
                margin-top: 12px;
                margin-bottom: 12px;
            }
            #search-input:focus {
                background-color: #b1ddf1;
            }
            kbd {
                border-radius: 4px;
                display: inline-block;
                font-size: 0.85em;
                line-height: 1;
                padding: 2px 4px;
                white-space: nowrap;

                background-color: #393c41;
                border: 1px solid #494b50;
                box-shadow: 0 -4px 0 0 #3f4247 inset;
                color: #fff;
                user-select: none;
            }
            .search-result {
                display: flex;
                flex-direction: row;
                align-items: center;
                justify-content: start;
                gap: 6px;
                margin-bottom: 4px;
            }
            .search-goto {
                width: 1.5em;
                height: 1.5em;
                padding: 0.25em;
                border: 1px solid #494b50;
                background-color: #393c41;
                cursor: pointer;
            }
        </style>
    </head>
    <body>
        <div id='search'>
            <h1>module search</h1>
            <input id="search-input"></input>
            <h1 id="search-results-title">search results</h1>
            <div id="search-results"></div>
        </div>
        <div id='graph'></div>
        <div id='notes'>
            <h1>cpython {!{VERSION}!} module dependencies</h1>
            <p>made by <a href="https://github.com/quasar098" target="_blank">quasar098</a></p>
            <br>
            <p>blue = dependents (___ imports it)</p>
            <p>red = dependencies (it imports ___)</p>
            <br>
            <p>* = probably inside a function</p>
            <br>
            <p><kbd>ctrl</kbd> + <kbd>f</kbd> - select search box</p>
            <br>
            <p><kbd>enter</kbd> - quick goto module</p>
            <br>
            <h1>references to</h1>
            <div id='parents'></div>
            <h1>references from</h1>
            <div id='children'></div>
        </div>

        <!-- todo remove useless -->
        <script src="cytoscape.min.js"></script>
        <script src="https://unpkg.com/webcola/WebCola/cola.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/cytoscape/cytoscape.js-cose-bilkent@1.6.5/cytoscape-cose-bilkent.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/cytoscape-tidytree/dist/cytoscape-tidytree.js"></script>
        <script src="cytoscape-cola.js"></script>
        <script src="https://unpkg.com/layout-base/layout-base.js"></script>
        <script src="https://unpkg.com/cose-base/cose-base.js"></script>
        <script src="https://unpkg.com/cytoscape-fcose/cytoscape-fcose.js"></script>
        <script>
            let data = JSON.parse(`{!{DATA}!}`)  // this gets replaced with the actual data
            // todo: fix injection/xss/whatever with backtick

            let elements = [];

            let get_outgoing = {};//Object.assign({}, ...cy.nodes().map(q => ({[q.id()]: []})));
            let get_ingoing = {};//Object.assign({}, ...cy.nodes().map(q => ({[q.id()]: []})));

            // nodes
            let all_module_names = [];
            for (let module_name of Object.keys(data['deps'])) {
                if (data['deps'][module_name].length != 0) {
                    all_module_names.push(module_name);
                }
                for (let imp of data['deps'][module_name]) {
                    if (!imp.is_import_from) {
                        for (let modpath of imp.modpaths) {
                            all_module_names.push(modpath[0]);
                        }
                    } else {
                        all_module_names.push(imp.module_name);
                    }
                }
            }
            for (let module_name of [... new Set(all_module_names)]) {
                elements.push({'data': {'id': module_name}});
            }

            // edges
            for (let module_name of Object.keys(data['deps'])) {
                for (let imp of data['deps'][module_name]) {
                    if (!imp.is_import_from) {
                        for (let modpath of imp.modpaths) {
                            // [og_name, renamed]
                            let [og_name, renamed] = modpath;
                            if (og_name == module_name) continue;
                            if (get_outgoing[module_name] == undefined) get_outgoing[module_name] = [];
                            if (get_ingoing[module_name] == undefined) get_ingoing[module_name] = [];
                            if (get_outgoing[og_name] == undefined) get_outgoing[og_name] = [];
                            if (get_ingoing[og_name] == undefined) get_ingoing[og_name] = [];
                            get_outgoing[module_name].push(og_name);
                            get_ingoing[og_name].push(module_name);
                            elements.push({
                                data: {'id': imp.import_text + '' + imp.line_num, 'source': module_name, 'target': og_name, 'label': imp.import_text}
                            });
                        }
                    } else {
                        if (imp.module_name == module_name) continue;
                        if (get_outgoing[module_name] == undefined) get_outgoing[module_name] = [];
                        if (get_ingoing[module_name] == undefined) get_ingoing[module_name] = [];
                        if (get_outgoing[imp.module_name] == undefined) get_outgoing[imp.module_name] = [];
                        if (get_ingoing[imp.module_name] == undefined) get_ingoing[imp.module_name] = [];
                        get_outgoing[module_name].push(imp.module_name);
                        get_ingoing[imp.module_name].push(module_name);
                        elements.push({data: {'id': imp.import_text + '' + imp.line_num, 'source': module_name, 'target': imp.module_name, 'label': imp.import_text}})
                    }
                }
            }

            // random positioning
            position_map = {};
            for (let key of Object.keys(get_ingoing)) {
                let ingoing_count = get_ingoing[key].length + 1;
                position_map[key] = {x: (Math.random()-(0.5)) * 55000 / ingoing_count, y: (Math.random()-(0.5)) * 55000 / ingoing_count}
            }
            // general moving is top to bottom
            // for (let key of Object.keys(get_ingoing)) {
            //     position_map[key].y += 2000 * get_ingoing[key].length - 4000 * get_outgoing[key].length;
            // }
            // move all only-child nodes to be right next to their parent
            for (let key of Object.keys(get_ingoing)) {
                if (get_ingoing[key].length == 0 && get_outgoing[key].length == 1) {
                    let sd = position_map[get_outgoing[key][0]];  // sole descendant (position)
                    position_map[key] = {x: sd.x - 300, y: sd.y - 600};
                } else if (get_ingoing[key].length == 1 && get_outgoing[key].length == 0) {
                    let parentpos = position_map[get_ingoing[key][0]];
                    position_map[key] = {x: parentpos.x + 300, y: parentpos.y + 600};
                }
            }
            
            //cytoscape.use(cola);
            // todo consider https://github.com/chuckzel/cytoscape-tidytree
            var cy = cytoscape({
                layout: {
                    'name': 'preset',
                    //animate: false,

                    // preset
                    'positions': (n) => {
                        return position_map[n.id()];
                    },

                    // random
                    //transform: ((node, pos) => ({x: pos.x*30, y: pos.y*30})),

                    // breadthfirst
                    //directed: true,
                    //padding: 30,
                    //avoidOverlap: true,
                    //nodeDimensionsIncludeLabels: true,
                    //spacingFactor: 1.5,
                    
                    // fcose
                    //nodeSeparation: 200,
                    //nodeRepulsion: () => 40000,
                    //idealEdgeLength: () => 150,
                    //animationDuration: 300,

                    // cola
                    //maxSimulationTime: 100000,
                    //nodeSpacing: () => 50,
                    //flow: { axis: 'y', minSeparation: 100 },
                    //nodeDimensionsIncludeLabels: true,
                    //randomize: false,
                    //edgeLength: 400,
                    //fit: false,
                },
                container: document.getElementById('graph'),
                elements: elements,
                wheelSensitivity: 0.5,
                style: [
                    {
                        selector: 'core',
                        style: {
                            'active-bg-opacity': 0,
                            'active-bg-color': '#ff00ff',
                        }
                    },
                    {
                        selector: 'node:selected',
                        style: {
                            'background-color': '#ffffff',
                            'border-width': '0px', // Remove any border width
                            'border-color': 'transparent', // Optionally make border color transparent
                            'outline-width': '0px', // Remove any outline if applied
                            'overlay-opacity': 0
                        }
                    },
                    {
                        selector: 'node:active',
                        style: {
                            'background-color': '#ffffff',
                            'border-width': '0px', // Remove any border width
                            'border-color': 'transparent', // Optionally make border color transparent
                            'outline-width': '0px', // Remove any outline if applied
                            'overlay-opacity': 0
                        }
                    },
                    {
                        selector: 'node',
                        style: {
                            'label': 'data(id)',
                            'color': '#00ff00',
                            'font-size': '100px',
                            'width': '30px',
                            'height': '30px',
                        }
                    },
                    {
                        selector: 'node.highlighted',
                        style: {
                            'background-color': '#ffffff',
                            'font-size': '500px',
                            'color': '#00ff00',
                            'width': '200px',
                            'height': '200px',
                        }
                    },
                    {
                        selector: 'node.highlighted-child',
                        style: {
                            'font-size': '400px',
                            'background-color': '#ff0000',
                            'width': '200px',
                            'height': '200px',
                        }
                    },
                    {
                        selector: 'node.highlighted-parent',
                        style: {
                            'font-size': '400px',
                            'background-color': '#0000ff',
                            'width': '200px',
                            'height': '200px',
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'curve-style': 'round-taxi',
                            'taxi-direction': 'downward',
                            'target-arrow-shape': 'vee',
                            'arrow-scale': 3,
                            //'edge-text-rotation': 'autorotate',
                            //'control-point-step-size': 50,
                            'color': 'white',
                        }
                    },
                    {
                        selector: 'edge.highlighted-child',
                        style: {
                            'line-color': '#ff0000', 
                            'target-arrow-color': '#ff0000',
                            'source-arrow-color': '#ff0000',
                            'width': 20, // Optional: Make edges thicker
                            'z-index': 9999,
                        }
                    },
                    {
                        selector: 'edge.highlighted-parent',
                        style: {
                            'line-color': '#0000ff',
                            'target-arrow-color': '#0000ff',
                            'source-arrow-color': '#0000ff',
                            'width': 20,
                            'z-index': 9999,
                        }
                    }
                ]
            });

            // cola stuff
            cy.layout({
                'name': 'cola',
                maxSimulationTime: 100000,
                nodeSpacing: () => 30,
                nodeDimensionsIncludeLabels: false,
                convergenceThreshold: 1,
                randomize: false,
                edgeLength: ((e) => {
                    let res = Math.pow((get_outgoing[e.source().id()].length-1)*(get_ingoing[e.target().id()].length-1), 0.75)*100+200;
                    console.log(e.source().id(), e.target().id(), res);
                    return res;
                }),  // todo better idea i have better idea
                fit: false,
            }).run()

            let children = document.getElementById('children');
            let parents = document.getElementById('parents');
            
            // code reference element
            function cre(node_name, line_num, line_text, toplvl) {
                let filename = node_name + '.py';
                let elm = document.createElement('div');
                elm.classList.add('code-reference-element');

                let where = document.createElement('p');
                let whereLink = document.createElement('a');
                whereLink.innerText = 'Lib/' + filename;
                whereLink.setAttribute('href', `https://github.com/python/cpython/blob/v${data['python-version']}/Lib/${filename}#L${line_num}`)  // epic injection area
                whereLink.setAttribute('target', '_blank');
                //whereLink.addEventListener('click', () => {select(cy.nodes().filter(n => n.id() == node_name))})
                where.classList.add('where');
                where.appendChild(whereLink);
                where.append(', line ' + line_num + (toplvl ? '' : '*'))
                elm.appendChild(where);

                let line = document.createElement('p');
                line.classList.add('line');
                line.innerText = line_text;
                elm.appendChild(line);

                return elm;
            }

            function select(node) {
                cy.edges().removeClass('highlighted-parent');
                cy.edges().removeClass('highlighted-child');
                cy.nodes().removeClass('highlighted');
                cy.nodes().removeClass('highlighted-child');
                cy.nodes().removeClass('highlighted-parent');

                while (children.firstChild) {
                    children.removeChild(children.lastChild);
                }
                while (parents.firstChild) {
                    parents.removeChild(parents.lastChild);
                }

                node.addClass('highlighted');
                let child_edges = node.connectedEdges().filter(edge => edge.source().id() === node.id());
                let parent_edges = node.connectedEdges().filter(edge => edge.target().id() === node.id());
                child_edges.addClass('highlighted-child');
                parent_edges.addClass('highlighted-parent');
                child_edges.map(edge => edge.target().addClass('highlighted-child'));
                parent_edges.map(edge => edge.source().addClass('highlighted-parent'));

                if (Object.keys(data['deps']).includes(node.id())) {
                    for (let imp of data['deps'][node.id()]) {
                        children.appendChild(cre(node.id(), imp.line_num, imp.import_text, imp.toplvl));
                    }
                }

                for (let other_import_me of [...new Set(parent_edges.map(node => node.source().data()['id']))]) {
                    for (let imp of data['deps'][other_import_me]) {
                        if (imp.is_import_from) {
                            if (imp.module_name == node.id()) {
                                parents.appendChild(cre(other_import_me, imp.line_num, imp.import_text, imp.toplvl));
                            }
                        } else {
                            if (imp.modpaths.map(m => m[0] == node.id()).indexOf(true)+1) {  // cursed a bit
                                parents.appendChild(cre(other_import_me, imp.line_num, imp.import_text, imp.toplvl));
                            }
                        }
                    }
                }
            }

            cy.on('tapstart', 'node', (evt) => {
                const node = evt.target;
                
                select(node);
            });

            let searchInp = document.getElementById('search-input');
            let searchResultsTitle = document.getElementById('search-results-title');
            let searchResults = document.getElementById('search-results');

            let searchInpFocused = false;
            
            let updateSearchResults = (query) => {
                while (searchResults.firstChild) {
                    searchResults.removeChild(searchResults.lastChild);
                }
                let names = cy.nodes().map(n => n.id()).filter(name => name.includes(query));  // todo use fuse.js
                searchResultsTitle.innerText = names.length == 0 ? 'no results' : `results (${names.length})`;
                for (let name of names) {
                    let moduleDiv = document.createElement('div');
                    moduleDiv.classList.add('search-result');
                    let gotoButton = document.createElement('button');
                    gotoButton.classList.add('search-goto');
                    let gotoImg = document.createElement('img');
                    gotoImg.setAttribute('src', 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48IS0tIUZvbnQgQXdlc29tZSBGcmVlIDYuNy4yIGJ5IEBmb250YXdlc29tZSAtIGh0dHBzOi8vZm9udGF3ZXNvbWUuY29tIExpY2Vuc2UgLSBodHRwczovL2ZvbnRhd2Vzb21lLmNvbS9saWNlbnNlL2ZyZWUgQ29weXJpZ2h0IDIwMjUgRm9udGljb25zLCBJbmMuLS0+PHBhdGggZmlsbD0iI2ZmZmZmZiIgZD0iTTQxNiAyMDhjMCA0NS45LTE0LjkgODguMy00MCAxMjIuN0w1MDIuNiA0NTcuNGMxMi41IDEyLjUgMTIuNSAzMi44IDAgNDUuM3MtMzIuOCAxMi41LTQ1LjMgMEwzMzAuNyAzNzZjLTM0LjQgMjUuMi03Ni44IDQwLTEyMi43IDQwQzkzLjEgNDE2IDAgMzIyLjkgMCAyMDhTOTMuMSAwIDIwOCAwUzQxNiA5My4xIDQxNiAyMDh6TTIwOCAzNTJhMTQ0IDE0NCAwIDEgMCAwLTI4OCAxNDQgMTQ0IDAgMSAwIDAgMjg4eiIvPjwvc3ZnPg==');
                    gotoButton.appendChild(gotoImg);
                    gotoButton.addEventListener('click', () => {
                        cy.zoom(0.2);
                        cy.center(cy.nodes().filter(q => q.id() == name));
                    })
                    let moduleNameP = document.createElement('p');
                    moduleNameP.classList.add('search-result-module-name');
                    if (data['deps'][name]) {
                        let moduleNameA = document.createElement('a');
                        moduleNameP.appendChild(moduleNameA);
                        moduleNameA.setAttribute('href', `https://github.com/python/cpython/blob/v${data['python-version']}/Lib/${name}.py`);
                        moduleNameA.innerText = name
                        moduleNameA.setAttribute('target', '_blank');
                    } else {
                        moduleNameP.innerText = name;
                    }
                    moduleDiv.appendChild(gotoButton);
                    moduleDiv.appendChild(moduleNameP);
                    searchResults.appendChild(moduleDiv);
                }
            }

            searchInp.addEventListener('focus', (e) => { searchInpFocused = true; });
            searchInp.addEventListener('blur', (e) => { searchInpFocused = false; });
            searchInp.addEventListener('keydown', (e) => {
                let query = searchInp.value;
                if (e.code == 'Enter') {
                    let names = cy.nodes().map(n => n.id()).filter(name => name.includes(query));
                    if (names.length > 0) {
                        let name = names[0];
                        if (names.includes(query)) {
                            name = query;
                        }
                        cy.zoom(0.2);
                        cy.center(cy.nodes().filter(q => q.id() == name));
                        searchInp.blur();
                    }
                }
                setTimeout(() => {  // legendary jank
                    let query = searchInp.value;
                    if (query.length == 0) {
                        searchResultsTitle.style.display = 'none';
                        searchResults.style.display = 'none';
                    } else {
                        searchResultsTitle.style.display = 'block';
                        searchResults.style.display = 'block';
                        updateSearchResults(query);
                    }
                }, 1);
            });
            if (searchInp.value.length == 0) {
                searchResultsTitle.style.display = 'none';
                searchResults.style.display = 'none';
            } else {
                updateSearchResults(searchInp.value);
            }

            document.addEventListener('keydown', (e) => {
                if (e.key == 'f' && e.ctrlKey) {
                    if (!searchInpFocused) {
                        searchInp.selectionStart = 0;
                        searchInp.selectionEnd = 1000;
                        searchInp.focus();
                        e.preventDefault();
                        return false;
                    } else {
                        searchInp.blur()
                    }
                }
            });
        </script>
    </body>
</html>
